services:
  spark-master:
    image: ${SPARK_IMAGE:-apache/spark:latest}
    container_name: spark-master
    command:
      - /opt/spark/bin/spark-class
      - org.apache.spark.deploy.master.Master
      - --host
      - spark-master
      - --port
      - "7077"
      - --webui-port
      - "8080"
    ports:
      - "7077:7077"
      - "8080:8080"
    volumes:
      - ./app:/opt/spark-apps

  spark-worker:
    image: ${SPARK_IMAGE:-apache/spark:latest}
    container_name: spark-worker
    depends_on:
      - spark-master
    command:
      - /opt/spark/bin/spark-class
      - org.apache.spark.deploy.worker.Worker
      - spark://spark-master:7077
      - --webui-port
      - "8081"
      - --cores
      - "1"
      - --memory
      - 1g
    ports:
      - "8081:8081"
    volumes:
      - ./app:/opt/spark-apps

  spark-submit:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SPARK_IMAGE: ${SPARK_IMAGE:-apache/spark:latest}
    container_name: spark-submit
    depends_on:
      - spark-master
      - spark-worker
    environment:
      - SPARK_MASTER_URL=spark://spark-master:7077
    volumes:
      - ./app:/opt/spark-apps
      - ./scripts:/opt/spark-scripts
    entrypoint: ["/bin/bash", "-lc"]
    command: ["/opt/spark-scripts/submit.sh"]
